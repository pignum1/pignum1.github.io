<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="spring cloud alibaba,shiro,">










<meta name="description" content="Spring cloud 集成shiro使用的redis作为缓存,不多逼逼，直接上代码 自定义序列化类SerializeUtils12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667public cla">
<meta name="keywords" content="spring cloud alibaba,shiro">
<meta property="og:type" content="article">
<meta property="og:title" content="spring-cloud 集成shiro">
<meta property="og:url" content="http://yoursite.com/2020/05/25/spring-cloud-集成shiro/index.html">
<meta property="og:site_name" content="风寒露重">
<meta property="og:description" content="Spring cloud 集成shiro使用的redis作为缓存,不多逼逼，直接上代码 自定义序列化类SerializeUtils12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667public cla">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-05-25T07:34:41.032Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="spring-cloud 集成shiro">
<meta name="twitter:description" content="Spring cloud 集成shiro使用的redis作为缓存,不多逼逼，直接上代码 自定义序列化类SerializeUtils12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667public cla">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/05/25/spring-cloud-集成shiro/">





  <title>spring-cloud 集成shiro | 风寒露重</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	<a href="https://github.com/pignum1/pignum1.github.io.git">
		<img style="position: absolute; top: 0; right: 0;border: 0;" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风寒露重</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/25/spring-cloud-集成shiro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wei xy">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/sliver.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风寒露重">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">spring-cloud 集成shiro</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-25T14:19:41+08:00">
                2020-05-25
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-05-25T15:34:41+08:00">
                2020-05-25
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring-cloud-alibaba/" itemprop="url" rel="index">
                    <span itemprop="name">spring cloud alibaba</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Spring-cloud-集成shiro"><a href="#Spring-cloud-集成shiro" class="headerlink" title="Spring cloud 集成shiro"></a>Spring cloud 集成shiro</h1><p>使用的redis作为缓存,不多逼逼，直接上代码</p>
<h3 id="自定义序列化类SerializeUtils"><a href="#自定义序列化类SerializeUtils" class="headerlink" title="自定义序列化类SerializeUtils"></a>自定义序列化类SerializeUtils</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">public class SerializeUtils implements RedisSerializer &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(SerializeUtils.class);</span><br><span class="line"></span><br><span class="line">    public static boolean isEmpty(byte[] data) &#123;</span><br><span class="line">        return (data == null || data.length == 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 序列化</span><br><span class="line">     * @param object</span><br><span class="line">     * @return</span><br><span class="line">     * @throws SerializationException</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public byte[] serialize(Object object) throws SerializationException &#123;</span><br><span class="line">        byte[] result = null;</span><br><span class="line"></span><br><span class="line">        if (object == null) &#123;</span><br><span class="line">            return new byte[0];</span><br><span class="line">        &#125;</span><br><span class="line">        try (</span><br><span class="line">                ByteArrayOutputStream byteStream = new ByteArrayOutputStream(128);</span><br><span class="line">                ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteStream)</span><br><span class="line">        )&#123;</span><br><span class="line"></span><br><span class="line">            if (!(object instanceof Serializable)) &#123;</span><br><span class="line">                throw new IllegalArgumentException(SerializeUtils.class.getSimpleName() + &quot; requires a Serializable payload &quot; +</span><br><span class="line">                        &quot;but received an object of type [&quot; + object.getClass().getName() + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            objectOutputStream.writeObject(object);</span><br><span class="line">            objectOutputStream.flush();</span><br><span class="line">            result =  byteStream.toByteArray();</span><br><span class="line">        &#125; catch (Exception ex) &#123;</span><br><span class="line">            logger.error(&quot;Failed to serialize&quot;,ex);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 反序列化</span><br><span class="line">     * @param bytes</span><br><span class="line">     * @return</span><br><span class="line">     * @throws SerializationException</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public Object deserialize(byte[] bytes) throws SerializationException &#123;</span><br><span class="line"></span><br><span class="line">        Object result = null;</span><br><span class="line"></span><br><span class="line">        if (isEmpty(bytes)) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try (</span><br><span class="line">                ByteArrayInputStream byteStream = new ByteArrayInputStream(bytes);</span><br><span class="line">                ObjectInputStream objectInputStream = new ObjectInputStream(byteStream)</span><br><span class="line">        )&#123;</span><br><span class="line">            result = objectInputStream.readObject();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;Failed to deserialize&quot;,e);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RedisConfig"><a href="#RedisConfig" class="headerlink" title="RedisConfig"></a>RedisConfig</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">package com.panghu.config;</span><br><span class="line"></span><br><span class="line">import com.panghu.global.MyByteSource;</span><br><span class="line">import com.panghu.global.SerializeUtils;</span><br><span class="line">import lombok.Data;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line">import org.springframework.cache.annotation.CachingConfigurerSupport;</span><br><span class="line">import org.springframework.cache.annotation.EnableCaching;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line">import org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line">import org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line">import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line">import org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line">import redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @ProjectName: nacos_base4j</span><br><span class="line"> * @Package: com.panghu.config</span><br><span class="line"> * @ClassName: RedisConfig</span><br><span class="line"> * @Author: wxy</span><br><span class="line"> * @Description: redis配置类</span><br><span class="line"> * @Date: 2020/5/18 10:35</span><br><span class="line"> * @Version: 1.0</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableCaching</span><br><span class="line">@Data</span><br><span class="line">public class RedisConfig extends CachingConfigurerSupport &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * spring管理自动注入  redisTemplate &lt;String ,Object&gt;</span><br><span class="line">     *</span><br><span class="line">     * @param factory</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean(name = &quot;redisTemplate&quot;)</span><br><span class="line">    public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory factory) &#123;</span><br><span class="line">        // 1.创建 redisTemplate 模版</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;&gt;();</span><br><span class="line">        // 2.关联 redisConnectionFactory</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line">        // 3.创建 自定义序列化类</span><br><span class="line"></span><br><span class="line">//        FastJsonRedisSerializer myRedisSerializer = new FastJsonRedisSerializer(Object.class);</span><br><span class="line">        // 7.设置 value 的转化格式和 key 的转化格式 默认使用的是JdkSerializationRedisSerializer</span><br><span class="line">//        template.setValueSerializer(myRedisSerializer);</span><br><span class="line">//        template.setHashValueSerializer(myRedisSerializer);</span><br><span class="line">//        template.setDefaultSerializer(myRedisSerializer);</span><br><span class="line">        GenericJackson2JsonRedisSerializer jackson2JsonRedisSerializer = new GenericJackson2JsonRedisSerializer();</span><br><span class="line">        template.setValueSerializer(new SerializeUtils());</span><br><span class="line">        template.setHashValueSerializer(new SerializeUtils());</span><br><span class="line">        // 设置键（key）的序列化采用StringRedisSerializer。</span><br><span class="line">        template.setKeySerializer(new StringRedisSerializer());</span><br><span class="line">        template.setHashKeySerializer(new StringRedisSerializer());</span><br><span class="line"></span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        return template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * spring管理自动注入  redisTemplate &lt;String ,String&gt;</span><br><span class="line">     *</span><br><span class="line">     * @param factory</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean(StringRedisTemplate.class)</span><br><span class="line">    public RedisTemplate&lt;String, String&gt; stringRedisTemplate(RedisConnectionFactory factory) &#123;</span><br><span class="line">        return new StringRedisTemplate(factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">// ################################jedis连接池配置###################################</span><br><span class="line">    /**</span><br><span class="line">     * redis地址</span><br><span class="line">     */</span><br><span class="line">    @Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span><br><span class="line">    private String host;</span><br><span class="line">    /**</span><br><span class="line">     * redis端口号</span><br><span class="line">     */</span><br><span class="line">    @Value(&quot;$&#123;spring.redis.port&#125;&quot;)</span><br><span class="line">    private Integer port;</span><br><span class="line">//    /**</span><br><span class="line">//     * redis密码</span><br><span class="line">//     */</span><br><span class="line">//    @Value(&quot;$&#123;spring.redis.password&#125;&quot;)</span><br><span class="line">//    private String password;</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * JedisPoolConfig 连接池</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public JedisPoolConfig jedisPoolConfig() &#123;</span><br><span class="line">        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();</span><br><span class="line">        //最大空闲数</span><br><span class="line">        jedisPoolConfig.setMaxIdle(300);</span><br><span class="line">        //连接池的最大数据库连接数</span><br><span class="line">        jedisPoolConfig.setMaxTotal(1000);</span><br><span class="line">        //最大建立连接等待时间</span><br><span class="line">        jedisPoolConfig.setMaxWaitMillis(1000);</span><br><span class="line">        //逐出连接的最小空闲时间 默认1800000毫秒(30分钟)</span><br><span class="line">        jedisPoolConfig.setMinEvictableIdleTimeMillis(300000);</span><br><span class="line">        //每次逐出检查时 逐出的最大数目 如果为负数就是 : 1/abs(n), 默认3</span><br><span class="line">        jedisPoolConfig.setNumTestsPerEvictionRun(10);</span><br><span class="line">        //逐出扫描的时间间隔(毫秒) 如果为负数,则不运行逐出线程, 默认-1</span><br><span class="line">        jedisPoolConfig.setTimeBetweenEvictionRunsMillis(30000);</span><br><span class="line">        //是否在从池中取出连接前进行检验,如果检验失败,则从池中去除连接并尝试取出另一个</span><br><span class="line">        jedisPoolConfig.setTestOnBorrow(true);</span><br><span class="line">        //在空闲时检查有效性, 默认false</span><br><span class="line">        jedisPoolConfig.setTestWhileIdle(true);</span><br><span class="line">        return jedisPoolConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">//    /**</span><br><span class="line">//     * 配置工厂</span><br><span class="line">//     *</span><br><span class="line">//     * @param jedisPoolConfig</span><br><span class="line">//     * @return</span><br><span class="line">//     */</span><br><span class="line">//    @Bean</span><br><span class="line">//    public JedisConnectionFactory jedisConnectionFactory(JedisPoolConfig jedisPoolConfig) &#123;</span><br><span class="line">//        JedisConnectionFactory jedisConnectionFactory = new JedisConnectionFactory();</span><br><span class="line">//        //连接池</span><br><span class="line">//        jedisConnectionFactory.setPoolConfig(jedisPoolConfig);</span><br><span class="line">//        //IP地址</span><br><span class="line">//        jedisConnectionFactory.setHostName(host);</span><br><span class="line">//        //端口号</span><br><span class="line">//        jedisConnectionFactory.setPort(port);</span><br><span class="line">//        //如果Redis设置有密码</span><br><span class="line">////        jedisConnectionFactory.setPassword(password);</span><br><span class="line">//        //客户端超时时间单位是毫秒</span><br><span class="line">//        jedisConnectionFactory.setTimeout(5000);</span><br><span class="line">//        return jedisConnectionFactory;</span><br><span class="line">//    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="RedisManager"><a href="#RedisManager" class="headerlink" title="RedisManager"></a>RedisManager</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class RedisManager &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    //=============================common============================</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 指定缓存失效时间</span><br><span class="line">     *</span><br><span class="line">     * @param key  键</span><br><span class="line">     * @param time 时间(秒)</span><br><span class="line">     */</span><br><span class="line">    public void expire(String key, long time) &#123;</span><br><span class="line">        redisTemplate.expire(key, time, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 判断key是否存在</span><br><span class="line">     *</span><br><span class="line">     * @param key 键</span><br><span class="line">     * @return true 存在 false不存在</span><br><span class="line">     */</span><br><span class="line">    public Boolean hasKey(String key) &#123;</span><br><span class="line">        return redisTemplate.hasKey(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 删除缓存</span><br><span class="line">     *</span><br><span class="line">     * @param key 可以传一个值 或多个</span><br><span class="line">     */</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public void del(String... key) &#123;</span><br><span class="line">        if (key != null &amp;&amp; key.length &gt; 0) &#123;</span><br><span class="line">            if (key.length == 1) &#123;</span><br><span class="line">                redisTemplate.delete(key[0]);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                redisTemplate.delete(CollectionUtils.arrayToList(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 批量删除key</span><br><span class="line">     *</span><br><span class="line">     * @param keys</span><br><span class="line">     */</span><br><span class="line">    public void del(Collection keys) &#123;</span><br><span class="line">        redisTemplate.delete(keys);</span><br><span class="line">    &#125;</span><br><span class="line">    //============================String=============================</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 普通缓存获取</span><br><span class="line">     *</span><br><span class="line">     * @param key 键</span><br><span class="line">     * @return 值</span><br><span class="line">     */</span><br><span class="line">    public Object get(String key) &#123;</span><br><span class="line">        return redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 普通缓存放入</span><br><span class="line">     *</span><br><span class="line">     * @param key   键</span><br><span class="line">     * @param value 值</span><br><span class="line">     */</span><br><span class="line">    public void set(String key, Object value) &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 普通缓存放入并设置时间</span><br><span class="line">     *</span><br><span class="line">     * @param key   键</span><br><span class="line">     * @param value 值</span><br><span class="line">     * @param time  时间(秒) time要大于0 如果time小于等于0 将设置无限期</span><br><span class="line">     */</span><br><span class="line">    public void set(String key, Object value, long time) &#123;</span><br><span class="line">        if (time &gt; 0) &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            set(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 使用scan命令 查询某些前缀的key</span><br><span class="line">     *</span><br><span class="line">     * @param key</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public Set&lt;String&gt; scan(String key) &#123;</span><br><span class="line">        Set&lt;String&gt; execute = this.redisTemplate.execute(new RedisCallback&lt;Set&lt;String&gt;&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Set&lt;String&gt; doInRedis(RedisConnection connection) throws DataAccessException &#123;</span><br><span class="line">                Set&lt;String&gt; binaryKeys = new HashSet&lt;&gt;();</span><br><span class="line">                Cursor&lt;byte[]&gt; cursor = connection.scan(new ScanOptions.ScanOptionsBuilder().match(key).count(1000).build());</span><br><span class="line">                while (cursor.hasNext()) &#123;</span><br><span class="line">                    binaryKeys.add(new String(cursor.next()));</span><br><span class="line">                &#125;</span><br><span class="line">                return binaryKeys;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        return execute;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 使用scan命令 查询某些前缀的key 有多少个</span><br><span class="line">     * 用来获取当前session数量,也就是在线用户</span><br><span class="line">     *</span><br><span class="line">     * @param key</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public Long scanSize(String key) &#123;</span><br><span class="line">        long dbSize = this.redisTemplate.execute(new RedisCallback&lt;Long&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Long doInRedis(RedisConnection connection) throws DataAccessException &#123;</span><br><span class="line">                long count = 0L;</span><br><span class="line">                Cursor&lt;byte[]&gt; cursor = connection.scan(ScanOptions.scanOptions().match(key).count(1000).build());</span><br><span class="line">                while (cursor.hasNext()) &#123;</span><br><span class="line">                    cursor.next();</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                return count;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        return dbSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="redis-作为缓存管理shiro"><a href="#redis-作为缓存管理shiro" class="headerlink" title="redis 作为缓存管理shiro"></a>redis 作为缓存管理shiro</h2><p>使用Redis作为缓存需要shiro重写RedisCache、RedisCacheManager、SessionDAO</p>
<h3 id="RedisCache"><a href="#RedisCache" class="headerlink" title="RedisCache"></a>RedisCache</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line">public class RedisCache&lt;K,V&gt; implements Cache&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(RedisCache.class);</span><br><span class="line">    private RedisManager redisManager;</span><br><span class="line">    private String keyPrefix = &quot;&quot;;</span><br><span class="line">    private int expire = 0;</span><br><span class="line">    private String principalIdFieldName =  RedisCacheManager.DEFAULT_PRINCIPAL_ID_FIELD_NAME;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 构造方法</span><br><span class="line">     * @param redisManager</span><br><span class="line">     */</span><br><span class="line">    public RedisCache(RedisManager redisManager, String prefix, int expire, String principalIdFieldName) &#123;</span><br><span class="line">        if (redisManager == null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;redisManager cannot be null.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        this.redisManager = redisManager;</span><br><span class="line">        if (prefix != null &amp;&amp; !&quot;&quot;.equals(prefix)) &#123;</span><br><span class="line">            this.keyPrefix = prefix;</span><br><span class="line">        &#125;</span><br><span class="line">        if (expire != -1) &#123;</span><br><span class="line">            this.expire = expire;</span><br><span class="line">        &#125;</span><br><span class="line">        if (principalIdFieldName != null &amp;&amp; !&quot;&quot;.equals(principalIdFieldName)) &#123;</span><br><span class="line">            this.principalIdFieldName = principalIdFieldName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据key 获取value</span><br><span class="line">     * @param key</span><br><span class="line">     * @return</span><br><span class="line">     * @throws CacheException</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public V get(K key) throws CacheException &#123;</span><br><span class="line">        logger.debug(&quot;get key [&#123;&#125;]&quot;,key);</span><br><span class="line">        if (key == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            String redisCacheKey = getRedisCacheKey(key);</span><br><span class="line">            Object rawValue = redisManager.get(redisCacheKey);</span><br><span class="line">            if (rawValue == null) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            V value = (V) rawValue;</span><br><span class="line">            return value;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new CacheException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 存放key -value到缓存中</span><br><span class="line">     * @param key</span><br><span class="line">     * @param value</span><br><span class="line">     * @return</span><br><span class="line">     * @throws CacheException</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public V put(K key, V value) throws CacheException &#123;</span><br><span class="line">        logger.debug(&quot;put key [&#123;&#125;]&quot;,key);</span><br><span class="line">        if (key == null) &#123;</span><br><span class="line">            logger.warn(&quot;Saving a null key is meaningless, return value directly without call Redis.&quot;);</span><br><span class="line">            return value;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            String redisCacheKey = getRedisCacheKey(key);</span><br><span class="line">            redisManager.set(redisCacheKey, value != null ? value : null, expire);</span><br><span class="line">            return value;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new CacheException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 删除一个缓存数据源</span><br><span class="line">     * @param key</span><br><span class="line">     * @return</span><br><span class="line">     * @throws CacheException</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public V remove(K key) throws CacheException &#123;</span><br><span class="line">        logger.debug(&quot;remove key [&#123;&#125;]&quot;,key);</span><br><span class="line">        if (key == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            String redisCacheKey = getRedisCacheKey(key);</span><br><span class="line">            Object rawValue = redisManager.get(redisCacheKey);</span><br><span class="line">            V previous = (V) rawValue;</span><br><span class="line">            redisManager.del(redisCacheKey);</span><br><span class="line">            return previous;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new CacheException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private String getRedisCacheKey(K key) &#123;</span><br><span class="line">        if (key == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return this.keyPrefix + getStringRedisKey(key);</span><br><span class="line">    &#125;</span><br><span class="line">    private String getStringRedisKey(K key) &#123;</span><br><span class="line">        String redisKey;</span><br><span class="line">        if (key instanceof PrincipalCollection) &#123;</span><br><span class="line">            redisKey = getRedisKeyFromPrincipalIdField((PrincipalCollection) key);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            redisKey = key.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        return redisKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String getRedisKeyFromPrincipalIdField(PrincipalCollection key) &#123;</span><br><span class="line">        String redisKey;</span><br><span class="line">        Object principalObject = key.getPrimaryPrincipal();</span><br><span class="line">        Method pincipalIdGetter = null;</span><br><span class="line">        Method[] methods = principalObject.getClass().getDeclaredMethods();</span><br><span class="line">        for (Method m:methods) &#123;</span><br><span class="line">            if (RedisCacheManager.DEFAULT_PRINCIPAL_ID_FIELD_NAME.equals(this.principalIdFieldName)</span><br><span class="line">                    &amp;&amp; (&quot;getAuthCacheKey&quot;.equals(m.getName()) || &quot;getId&quot;.equals(m.getName()))) &#123;</span><br><span class="line">                pincipalIdGetter = m;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (m.getName().equals(&quot;get&quot; + this.principalIdFieldName.substring(0, 1).toUpperCase() + this.principalIdFieldName.substring(1))) &#123;</span><br><span class="line">                pincipalIdGetter = m;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (pincipalIdGetter == null) &#123;</span><br><span class="line">            throw new PrincipalInstanceException(principalObject.getClass(), this.principalIdFieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            Object idObj = pincipalIdGetter.invoke(principalObject);</span><br><span class="line">            if (idObj == null) &#123;</span><br><span class="line">                throw new PrincipalIdNullException(principalObject.getClass(), this.principalIdFieldName);</span><br><span class="line">            &#125;</span><br><span class="line">            redisKey = idObj.toString();</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            throw new PrincipalInstanceException(principalObject.getClass(), this.principalIdFieldName, e);</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            throw new PrincipalInstanceException(principalObject.getClass(), this.principalIdFieldName, e);</span><br><span class="line">        &#125;</span><br><span class="line">        return redisKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void clear() throws CacheException &#123;</span><br><span class="line">        logger.debug(&quot;clear cache&quot;);</span><br><span class="line">        Set&lt;String&gt; keys = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            keys = redisManager.scan(this.keyPrefix + &quot;*&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;get keys error&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        if (keys == null || keys.size() == 0) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        for (String key: keys) &#123;</span><br><span class="line">            redisManager.del(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public int size() &#123;</span><br><span class="line">        Long longSize = 0L;</span><br><span class="line">        try &#123;</span><br><span class="line">            longSize = new Long(redisManager.scanSize(this.keyPrefix + &quot;*&quot;));</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;get keys error&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        return longSize.intValue();</span><br><span class="line">    &#125;</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    @Override</span><br><span class="line">    public Set&lt;K&gt; keys() &#123;</span><br><span class="line">        Set&lt;String&gt; keys = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            keys = redisManager.scan(this.keyPrefix + &quot;*&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;get keys error&quot;, e);</span><br><span class="line">            return Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line">        if (CollectionUtils.isEmpty(keys)) &#123;</span><br><span class="line">            return Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line">        Set&lt;K&gt; convertedKeys = new HashSet&lt;K&gt;();</span><br><span class="line">        for (String key:keys) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                convertedKeys.add((K) key);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                logger.error(&quot;deserialize keys error&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return convertedKeys;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;V&gt; values() &#123;</span><br><span class="line">        Set&lt;String&gt; keys = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            keys = redisManager.scan(this.keyPrefix + &quot;*&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;get values error&quot;, e);</span><br><span class="line">            return Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line">        if (CollectionUtils.isEmpty(keys)) &#123;</span><br><span class="line">            return Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;V&gt; values = new ArrayList&lt;V&gt;(keys.size());</span><br><span class="line">        for (String key : keys) &#123;</span><br><span class="line">            V value = null;</span><br><span class="line">            try &#123;</span><br><span class="line">                value = (V) redisManager.get(key);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                logger.error(&quot;deserialize values= error&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">            if (value != null) &#123;</span><br><span class="line">                values.add(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return Collections.unmodifiableList(values);</span><br><span class="line">    &#125;</span><br><span class="line">    public String getKeyPrefix() &#123;</span><br><span class="line">        return keyPrefix;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setKeyPrefix(String keyPrefix) &#123;</span><br><span class="line">        this.keyPrefix = keyPrefix;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getPrincipalIdFieldName() &#123;</span><br><span class="line">        return principalIdFieldName;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setPrincipalIdFieldName(String principalIdFieldName) &#123;</span><br><span class="line">        this.principalIdFieldName = principalIdFieldName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RedisCacheManager"><a href="#RedisCacheManager" class="headerlink" title="RedisCacheManager"></a>RedisCacheManager</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">public class RedisCacheManager implements CacheManager &#123;</span><br><span class="line"></span><br><span class="line">    private final Logger logger = LoggerFactory.getLogger(RedisCacheManager.class);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * fast lookup by name map</span><br><span class="line">     */</span><br><span class="line">    private final ConcurrentMap&lt;String, Cache&gt; caches = new ConcurrentHashMap&lt;String, Cache&gt;();</span><br><span class="line">    private RedisManager redisManager;</span><br><span class="line">    /**</span><br><span class="line">     * expire time in seconds</span><br><span class="line">     */</span><br><span class="line">    private static final int DEFAULT_EXPIRE = 1800;</span><br><span class="line">    private int expire = DEFAULT_EXPIRE;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The Redis key prefix for caches</span><br><span class="line">     */</span><br><span class="line">    public static final String DEFAULT_CACHE_KEY_PREFIX = &quot;shiro:cache:&quot;;</span><br><span class="line">    private String keyPrefix = DEFAULT_CACHE_KEY_PREFIX;</span><br><span class="line">    public static final String DEFAULT_PRINCIPAL_ID_FIELD_NAME = &quot;authCacheKey or id&quot;;</span><br><span class="line">    private String principalIdFieldName = DEFAULT_PRINCIPAL_ID_FIELD_NAME;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public &lt;K, V&gt; Cache&lt;K, V&gt; getCache(String name) throws CacheException &#123;</span><br><span class="line">        logger.debug(&quot;get cache, name=&#123;&#125;&quot;,name);</span><br><span class="line">        Cache cache = caches.get(name);</span><br><span class="line">        if (cache == null) &#123;</span><br><span class="line">            cache = new RedisCache&lt;K, V&gt;(redisManager,keyPrefix + name + &quot;:&quot;, expire, principalIdFieldName);</span><br><span class="line">            caches.put(name, cache);</span><br><span class="line">        &#125;</span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Logger getLogger() &#123;</span><br><span class="line">        return logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public ConcurrentMap&lt;String, Cache&gt; getCaches() &#123;</span><br><span class="line">        return caches;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public RedisManager getRedisManager() &#123;</span><br><span class="line">        return redisManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setRedisManager(RedisManager redisManager) &#123;</span><br><span class="line">        this.redisManager = redisManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static int getDefaultExpire() &#123;</span><br><span class="line">        return DEFAULT_EXPIRE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getExpire() &#123;</span><br><span class="line">        return expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setExpire(int expire) &#123;</span><br><span class="line">        this.expire = expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String getDefaultCacheKeyPrefix() &#123;</span><br><span class="line">        return DEFAULT_CACHE_KEY_PREFIX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getKeyPrefix() &#123;</span><br><span class="line">        return keyPrefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setKeyPrefix(String keyPrefix) &#123;</span><br><span class="line">        this.keyPrefix = keyPrefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String getDefaultPrincipalIdFieldName() &#123;</span><br><span class="line">        return DEFAULT_PRINCIPAL_ID_FIELD_NAME;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPrincipalIdFieldName() &#123;</span><br><span class="line">        return principalIdFieldName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPrincipalIdFieldName(String principalIdFieldName) &#123;</span><br><span class="line">        this.principalIdFieldName = principalIdFieldName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RedisSessionDAO"><a href="#RedisSessionDAO" class="headerlink" title="RedisSessionDAO"></a>RedisSessionDAO</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">public class RedisSessionDAO extends AbstractSessionDAO &#123;</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(RedisSessionDAO.class);</span><br><span class="line">    private static final String DEFAULT_SESSION_KEY_PREFIX = &quot;shiro:session:&quot;;</span><br><span class="line">    private String keyPrefix = DEFAULT_SESSION_KEY_PREFIX;</span><br><span class="line">    private static final long DEFAULT_SESSION_IN_MEMORY_TIMEOUT = 1000L;</span><br><span class="line">    /**</span><br><span class="line">     * doReadSession be called about 10 times when login.</span><br><span class="line">     * Save Session in ThreadLocal to resolve this problem. sessionInMemoryTimeout is expiration of Session in ThreadLocal.</span><br><span class="line">     * The default value is 1000 milliseconds (1s).</span><br><span class="line">     * Most of time, you don&apos;t need to change it.</span><br><span class="line">     */</span><br><span class="line">    private long sessionInMemoryTimeout = DEFAULT_SESSION_IN_MEMORY_TIMEOUT;</span><br><span class="line">    /**</span><br><span class="line">     * expire time in seconds</span><br><span class="line">     */</span><br><span class="line">    private static final int DEFAULT_EXPIRE = -2;</span><br><span class="line">    private static final int NO_EXPIRE = -1;</span><br><span class="line">    /**</span><br><span class="line">     * Please make sure expire is longer than sesion.getTimeout()</span><br><span class="line">     */</span><br><span class="line">    private int expire = DEFAULT_EXPIRE;</span><br><span class="line">    private static final int MILLISECONDS_IN_A_SECOND = 1000;</span><br><span class="line">    private RedisManager redisManager;</span><br><span class="line">    private static ThreadLocal sessionsInThread = new ThreadLocal();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void update(Session session) throws UnknownSessionException &#123;</span><br><span class="line">        //如果会话过期/停止 没必要再更新了</span><br><span class="line">        try &#123;</span><br><span class="line">            if (session instanceof ValidatingSession &amp;&amp; !((ValidatingSession) session).isValid()) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            if (session instanceof ShiroSession) &#123;</span><br><span class="line">                // 如果没有主要字段(除lastAccessTime以外其他字段)发生改变</span><br><span class="line">                ShiroSession ss = (ShiroSession) session;</span><br><span class="line">                if (!ss.isChanged()) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                //如果没有返回 证明有调用 setAttribute往redis 放的时候永远设置为false</span><br><span class="line">                ss.setChanged(false);</span><br><span class="line">            &#125;</span><br><span class="line">            this.saveSession(session);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.warn(&quot;update Session is failed&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * save session</span><br><span class="line">     *</span><br><span class="line">     * @param session</span><br><span class="line">     * @throws UnknownSessionException</span><br><span class="line">     */</span><br><span class="line">    private void saveSession(Session session) throws UnknownSessionException &#123;</span><br><span class="line">        if (session == null || session.getId() == null) &#123;</span><br><span class="line">            logger.error(&quot;session or session id is null&quot;);</span><br><span class="line">            throw new UnknownSessionException(&quot;session or session id is null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        String key = getRedisSessionKey(session.getId());</span><br><span class="line">        if (expire == DEFAULT_EXPIRE) &#123;</span><br><span class="line">            this.redisManager.set(key, session, (int) (session.getTimeout() / MILLISECONDS_IN_A_SECOND));</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (expire != NO_EXPIRE &amp;&amp; expire * MILLISECONDS_IN_A_SECOND &lt; session.getTimeout()) &#123;</span><br><span class="line">            logger.warn(&quot;Redis session expire time: &quot;</span><br><span class="line">                    + (expire * MILLISECONDS_IN_A_SECOND)</span><br><span class="line">                    + &quot; is less than Session timeout: &quot;</span><br><span class="line">                    + session.getTimeout()</span><br><span class="line">                    + &quot; . It may cause some problems.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        this.redisManager.set(key, session, expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void delete(Session session) &#123;</span><br><span class="line">        if (session == null || session.getId() == null) &#123;</span><br><span class="line">            logger.error(&quot;session or session id is null&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            redisManager.del(getRedisSessionKey(session.getId()));</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;delete session error. session id= &#123;&#125;&quot;, session.getId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;Session&gt; getActiveSessions() &#123;</span><br><span class="line">        Set&lt;Session&gt; sessions = new HashSet&lt;Session&gt;();</span><br><span class="line">        try &#123;</span><br><span class="line">            Set&lt;String&gt; keys = redisManager.scan(this.keyPrefix + &quot;*&quot;);</span><br><span class="line">            if (keys != null &amp;&amp; keys.size() &gt; 0) &#123;</span><br><span class="line">                for (String key : keys) &#123;</span><br><span class="line">                    Session s = (Session) redisManager.get(key);</span><br><span class="line">                    sessions.add(s);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;get active sessions error.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return sessions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Long getActiveSessionsSize() &#123;</span><br><span class="line">        Long size = 0L;</span><br><span class="line">        try &#123;</span><br><span class="line">            size = redisManager.scanSize(this.keyPrefix + &quot;*&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;get active sessions error.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Serializable doCreate(Session session) &#123;</span><br><span class="line">        if (session == null) &#123;</span><br><span class="line">            logger.error(&quot;session is null&quot;);</span><br><span class="line">            throw new UnknownSessionException(&quot;session is null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        Serializable sessionId = this.generateSessionId(session);</span><br><span class="line">        this.assignSessionId(session, sessionId);</span><br><span class="line">        this.saveSession(session);</span><br><span class="line">        return sessionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Session doReadSession(Serializable sessionId) &#123;</span><br><span class="line">        if (sessionId == null) &#123;</span><br><span class="line">            logger.warn(&quot;session id is null&quot;);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        //线程缓存中获取sessionId</span><br><span class="line">        Session s = getSessionFromThreadLocal(sessionId);</span><br><span class="line">        if (s != null) &#123;</span><br><span class="line">            return s;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.debug(&quot;read session from redis&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            s = (Session) redisManager.get(getRedisSessionKey(sessionId));</span><br><span class="line">            setSessionToThreadLocal(sessionId, s);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(&quot;read session error. settionId= &#123;&#125;&quot;, sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        return s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void setSessionToThreadLocal(Serializable sessionId, Session s) &#123;</span><br><span class="line">        Map&lt;Serializable, SessionInMemory&gt; sessionMap = (Map&lt;Serializable, SessionInMemory&gt;) sessionsInThread.get();</span><br><span class="line">        if (sessionMap == null) &#123;</span><br><span class="line">            sessionMap = new HashMap&lt;Serializable, SessionInMemory&gt;();</span><br><span class="line">            sessionsInThread.set(sessionMap);</span><br><span class="line">        &#125;</span><br><span class="line">        SessionInMemory sessionInMemory = new SessionInMemory();</span><br><span class="line">        sessionInMemory.setCreateTime(new Date());</span><br><span class="line">        sessionInMemory.setSession(s);</span><br><span class="line">        sessionMap.put(sessionId, sessionInMemory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Session getSessionFromThreadLocal(Serializable sessionId) &#123;</span><br><span class="line">        Session s = null;</span><br><span class="line">        if (sessionsInThread.get() == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;Serializable, SessionInMemory&gt; sessionMap = (Map&lt;Serializable, SessionInMemory&gt;) sessionsInThread.get();</span><br><span class="line">        SessionInMemory sessionInMemory = sessionMap.get(sessionId);</span><br><span class="line">        if (sessionInMemory == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        Date now = new Date();</span><br><span class="line">        long duration = now.getTime() - sessionInMemory.getCreateTime().getTime();</span><br><span class="line">        if (duration &lt; sessionInMemoryTimeout) &#123;</span><br><span class="line">            s = sessionInMemory.getSession();</span><br><span class="line">            logger.debug(&quot;read session from memory&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            sessionMap.remove(sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        return s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private String getRedisSessionKey(Serializable sessionId) &#123;</span><br><span class="line">        return this.keyPrefix + sessionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public RedisManager getRedisManager() &#123;</span><br><span class="line">        return redisManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setRedisManager(RedisManager redisManager) &#123;</span><br><span class="line">        this.redisManager = redisManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getKeyPrefix() &#123;</span><br><span class="line">        return keyPrefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setKeyPrefix(String keyPrefix) &#123;</span><br><span class="line">        this.keyPrefix = keyPrefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public long getSessionInMemoryTimeout() &#123;</span><br><span class="line">        return sessionInMemoryTimeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSessionInMemoryTimeout(long sessionInMemoryTimeout) &#123;</span><br><span class="line">        this.sessionInMemoryTimeout = sessionInMemoryTimeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getExpire() &#123;</span><br><span class="line">        return expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setExpire(int expire) &#123;</span><br><span class="line">        this.expire = expire;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="shiro配置"><a href="#shiro配置" class="headerlink" title="shiro配置"></a>shiro配置</h2><h3 id="ShiroConfig"><a href="#ShiroConfig" class="headerlink" title="ShiroConfig"></a>ShiroConfig</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line">package com.panghu.config;</span><br><span class="line"></span><br><span class="line">import com.panghu.reids.RedisCacheManager;</span><br><span class="line">import com.panghu.reids.RedisManager;</span><br><span class="line">import com.panghu.reids.RedisSessionDAO;</span><br><span class="line">import com.panghu.shiro.*;</span><br><span class="line">import org.apache.shiro.mgt.SecurityManager;</span><br><span class="line">import org.apache.shiro.session.SessionListener;</span><br><span class="line">import org.apache.shiro.session.mgt.SessionManager;</span><br><span class="line">import org.apache.shiro.session.mgt.eis.JavaUuidSessionIdGenerator;</span><br><span class="line">import org.apache.shiro.session.mgt.eis.SessionDAO;</span><br><span class="line">import org.apache.shiro.session.mgt.eis.SessionIdGenerator;</span><br><span class="line">import org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line">import org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line">import org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line">import org.apache.shiro.web.filter.authc.FormAuthenticationFilter;</span><br><span class="line">import org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line">import org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line">import org.springframework.beans.factory.config.MethodInvokingFactoryBean;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.servlet.handler.SimpleMappingExceptionResolver;</span><br><span class="line"></span><br><span class="line">import javax.servlet.Filter;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.LinkedHashMap;</span><br><span class="line">import java.util.Properties;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @ProjectName: nacos_base4j</span><br><span class="line"> * @Package: com.panghu.config</span><br><span class="line"> * @ClassName: ShiroConfig</span><br><span class="line"> * @Author: wxy</span><br><span class="line"> * @Description: shiro配置</span><br><span class="line"> * @Date: 2020/5/5 14:19</span><br><span class="line"> * @Version: 1.0</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class ShiroConfig &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 过滤器配置</span><br><span class="line">     * @Param: [securityManager]</span><br><span class="line">     * @return: org.apache.shiro.spring.web.ShiroFilterFactoryBean</span><br><span class="line">     * @Author: Mr.Wei</span><br><span class="line">     * @Date: 2020/5/19</span><br><span class="line">     */</span><br><span class="line">    @Bean(name = &quot;shirFilter&quot;)</span><br><span class="line">    public ShiroFilterFactoryBean shirFilter(@Qualifier(&quot;securityManager&quot;) SecurityManager securityManager) &#123;</span><br><span class="line">        System.out.println(&quot;ShiroConfiguration.shirFilter()&quot;);</span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        // 如果不设置默认会自动寻找Web工程根目录下的&quot;/login.jsp&quot;页面,设置的话没经过验证会发送test请求到控制器，由控制器决定转到对应视图</span><br><span class="line">//        shiroFilterFactoryBean.setLoginUrl(&quot;/login&quot;);</span><br><span class="line">        // 登录成功后要跳转的链接url</span><br><span class="line">//        shiroFilterFactoryBean.setSuccessUrl(&quot;/index&quot;);</span><br><span class="line">        //未授权界面,该配置无效，并不会进行页面跳转</span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(&quot;/unauthorized&quot;);</span><br><span class="line"></span><br><span class="line">        //自定义拦截器限制并发人数,参考博客：</span><br><span class="line">        LinkedHashMap&lt;String, Filter&gt; filtersMap = new LinkedHashMap&lt;&gt;();</span><br><span class="line">        //限制同一帐号同时在线的个数</span><br><span class="line">//        filtersMap.put(&quot;kickout&quot;, kickoutSessionControlFilter());</span><br><span class="line">        //统计登录人数</span><br><span class="line">        shiroFilterFactoryBean.setFilters(filtersMap);</span><br><span class="line"></span><br><span class="line">        // 配置访问权限 必须是LinkedHashMap，因为它必须保证有序</span><br><span class="line">        // 过滤链定义，从上向下顺序执行，一般将 /**放在最为下边 --&gt; : 这是一个坑，一不小心代码就不好使了</span><br><span class="line">        LinkedHashMap&lt;String, String&gt; filterChainDefinitionMap = new LinkedHashMap&lt;&gt;();</span><br><span class="line">        //配置不登录可以访问的资源，anon 表示资源都可以匿名访问</span><br><span class="line">        //配置记住我或认证通过可以访问的地址</span><br><span class="line">//        filterChainDefinitionMap.put(&quot;/login&quot;, &quot;anon&quot;);</span><br><span class="line">        filterChainDefinitionMap.put(&quot;/&quot;, &quot;anon&quot;);</span><br><span class="line">        filterChainDefinitionMap.put(&quot;/druid/**&quot;, &quot;anon&quot;);</span><br><span class="line">        //解锁用户专用 测试用的</span><br><span class="line">        filterChainDefinitionMap.put(&quot;/unlockAccount&quot;, &quot;anon&quot;);</span><br><span class="line">        filterChainDefinitionMap.put(&quot;/Captcha.jpg&quot;, &quot;anon&quot;);</span><br><span class="line">        //logout是shiro提供的过滤器</span><br><span class="line">        filterChainDefinitionMap.put(&quot;/logout&quot;, &quot;logout&quot;);</span><br><span class="line">        //此时访问/user/delete需要delete权限,在自定义Realm中为用户授权。</span><br><span class="line">        //filterChainDefinitionMap.put(&quot;/user/delete&quot;, &quot;perms[\&quot;user:delete\&quot;]&quot;);</span><br><span class="line">        //其他资源都需要认证  authc 表示需要认证才能进行访问 user表示配置记住我或认证通过可以访问的地址</span><br><span class="line">        //如果开启限制同一账号登录,改为 .put(&quot;/**&quot;, &quot;kickout,user&quot;);</span><br><span class="line">//        filterChainDefinitionMap.put(&quot;/**&quot;, &quot;kickout,user&quot;);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">        return shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 配置核心安全事务管理器</span><br><span class="line">     * @Param: []</span><br><span class="line">     * @return: org.apache.shiro.mgt.SecurityMasnager</span><br><span class="line">     * @Author: Mr.Wei</span><br><span class="line">     * @Date: 2020/5/17</span><br><span class="line">     */</span><br><span class="line">    @Bean(name = &quot;securityManager&quot;)</span><br><span class="line">    public SecurityManager securityManager() &#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();</span><br><span class="line">        //自定义权限方法和权限方法</span><br><span class="line">        securityManager.setRealm(shiroRealm());</span><br><span class="line">        // 自定义session管理 使用redis</span><br><span class="line">        securityManager.setSessionManager(sessionManager());</span><br><span class="line">        // 自定义缓存实现 使用redis</span><br><span class="line">        securityManager.setCacheManager(redisCacheManager());</span><br><span class="line">        return securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 自定义权限/密码验证方式</span><br><span class="line">     * @Param: []</span><br><span class="line">     * @return: com.panghu.shiro.MyShiroRealm</span><br><span class="line">     * @Author: Mr.Wei</span><br><span class="line">     * @Date: 2020/5/17</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public ShiroRealm shiroRealm() &#123;</span><br><span class="line">        ShiroRealm shiroRealm = new ShiroRealm();</span><br><span class="line">        //启用全局缓存</span><br><span class="line">        shiroRealm.setCachingEnabled(true);</span><br><span class="line">        //启用身份验证缓存，即缓存AuthenticationInfo信息，默认false</span><br><span class="line">        shiroRealm.setAuthenticationCachingEnabled(true);</span><br><span class="line">        //缓存AuthenticationInfo信息的缓存名称 在ehcache-shiro.xml中有对应缓存的配置</span><br><span class="line">        shiroRealm.setAuthenticationCacheName(&quot;authenticationCache&quot;);</span><br><span class="line">        //启用授权缓存，即缓存AuthorizationInfo信息，默认false</span><br><span class="line">        shiroRealm.setAuthorizationCachingEnabled(true);</span><br><span class="line">        //缓存AuthorizationInfo信息的缓存名称  在ehcache-shiro.xml中有对应缓存的配置</span><br><span class="line">        shiroRealm.setAuthorizationCacheName(&quot;authorizationCache&quot;);</span><br><span class="line">        //设置自定义密码匹配</span><br><span class="line">        shiroRealm.setCredentialsMatcher(retryLimitHashedCredentialsMatcher());</span><br><span class="line">        return shiroRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置Shiro生命周期处理器</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean(name = &quot;lifecycleBeanPostProcessor&quot;)</span><br><span class="line">    public LifecycleBeanPostProcessor lifecycleBeanPostProcessor() &#123;</span><br><span class="line">        return new LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 开启shiro aop注解支持.</span><br><span class="line">     * 使用代理方式;所以需要开启代码支持;</span><br><span class="line">     *</span><br><span class="line">     * @param securityManager</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(SecurityManager securityManager) &#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = new AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">        return authorizationAttributeSourceAdvisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 解决： 无权限页面不跳转 shiroFilterFactoryBean.setUnauthorizedUrl(&quot;/unauthorized&quot;) 无效</span><br><span class="line">     * shiro的源代码ShiroFilterFactoryBean.Java定义的filter必须满足filter instanceof AuthorizationFilter，</span><br><span class="line">     * 只有perms，roles，ssl，rest，port才是属于AuthorizationFilter，而anon，authcBasic，auchc，user是AuthenticationFilter，</span><br><span class="line">     * 所以unauthorizedUrl设置后页面不跳转 Shiro注解模式下，登录失败与没有权限都是通过抛出异常。</span><br><span class="line">     * 并且默认并没有去处理或者捕获这些异常。在SpringMVC下需要配置捕获相应异常来通知用户信息</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public SimpleMappingExceptionResolver simpleMappingExceptionResolver() &#123;</span><br><span class="line">        SimpleMappingExceptionResolver simpleMappingExceptionResolver = new SimpleMappingExceptionResolver();</span><br><span class="line">        Properties properties = new Properties();</span><br><span class="line">        //这里的 /unauthorized 是页面，不是访问的路径</span><br><span class="line">        properties.setProperty(&quot;org.apache.shiro.authz.UnauthorizedException&quot;, &quot;/unauthorized&quot;);</span><br><span class="line">        properties.setProperty(&quot;org.apache.shiro.authz.UnauthenticatedException&quot;, &quot;/unauthorized&quot;);</span><br><span class="line">        simpleMappingExceptionResolver.setExceptionMappings(properties);</span><br><span class="line">        return simpleMappingExceptionResolver;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * FormAuthenticationFilter 过滤器 过滤记住我</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public FormAuthenticationFilter formAuthenticationFilter() &#123;</span><br><span class="line">        FormAuthenticationFilter formAuthenticationFilter = new FormAuthenticationFilter();</span><br><span class="line">        //对应前端的checkbox的name = rememberMe</span><br><span class="line">        formAuthenticationFilter.setRememberMeParam(&quot;rememberMe&quot;);</span><br><span class="line">        return formAuthenticationFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * shiro缓存管理器;</span><br><span class="line">     * 需要添加到securityManager中</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public RedisCacheManager redisCacheManager() &#123;</span><br><span class="line">        RedisCacheManager redisCacheManager = new RedisCacheManager();</span><br><span class="line">        redisCacheManager.setRedisManager(redisManager());</span><br><span class="line">        //redis中针对不同用户缓存</span><br><span class="line">        redisCacheManager.setPrincipalIdFieldName(&quot;username&quot;);</span><br><span class="line">        //用户权限信息缓存时间</span><br><span class="line">        redisCacheManager.setExpire(200000);</span><br><span class="line">        return redisCacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 让某个实例的某个方法的返回值注入为Bean的实例</span><br><span class="line">     * Spring静态注入</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public MethodInvokingFactoryBean getMethodInvokingFactoryBean() &#123;</span><br><span class="line">        MethodInvokingFactoryBean factoryBean = new MethodInvokingFactoryBean();</span><br><span class="line">        factoryBean.setStaticMethod(&quot;org.apache.shiro.SecurityUtils.setSecurityManager&quot;);</span><br><span class="line">        factoryBean.setArguments(new Object[]&#123;securityManager()&#125;);</span><br><span class="line">        return factoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置session监听</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean(&quot;sessionListener&quot;)</span><br><span class="line">    public ShiroSessionListener sessionListener() &#123;</span><br><span class="line">        ShiroSessionListener sessionListener = new ShiroSessionListener();</span><br><span class="line">        return sessionListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置会话ID生成器</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public SessionIdGenerator sessionIdGenerator() &#123;</span><br><span class="line">        return new JavaUuidSessionIdGenerator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public RedisManager redisManager() &#123;</span><br><span class="line">        RedisManager redisManager = new RedisManager();</span><br><span class="line">        return redisManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean(&quot;sessionFactory&quot;)</span><br><span class="line">    public ShiroSessionFactory sessionFactory() &#123;</span><br><span class="line">        ShiroSessionFactory sessionFactory = new ShiroSessionFactory();</span><br><span class="line">        return sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * SessionDAO的作用是为Session提供CRUD并进行持久化的一个shiro组件</span><br><span class="line">     * MemorySessionDAO 直接在内存中进行会话维护</span><br><span class="line">     * EnterpriseCacheSessionDAO  提供了缓存功能的会话维护，默认情况下使用MapCache实现，内部使用ConcurrentHashMap保存缓存的会话。</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public SessionDAO sessionDAO() &#123;</span><br><span class="line">        RedisSessionDAO redisSessionDAO = new RedisSessionDAO();</span><br><span class="line">        redisSessionDAO.setRedisManager(redisManager());</span><br><span class="line">        redisSessionDAO.setSessionIdGenerator(sessionIdGenerator());</span><br><span class="line">        //session在redis中的保存时间,最好大于session会话超时时间</span><br><span class="line">        redisSessionDAO.setExpire(12000);</span><br><span class="line">        return redisSessionDAO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置会话管理器，设定会话超时及保存</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean(&quot;sessionManager&quot;)</span><br><span class="line">    public SessionManager sessionManager() &#123;</span><br><span class="line">        ShiroSessionManager sessionManager = new ShiroSessionManager();</span><br><span class="line">        Collection&lt;SessionListener&gt; listeners = new ArrayList&lt;SessionListener&gt;();</span><br><span class="line">        //配置监听</span><br><span class="line">        listeners.add(sessionListener());</span><br><span class="line">        sessionManager.setSessionListeners(listeners);</span><br><span class="line">//        sessionManager.setSessionIdCookie(sessionIdCookie());</span><br><span class="line">        sessionManager.setSessionDAO(sessionDAO());</span><br><span class="line">        sessionManager.setCacheManager(redisCacheManager());</span><br><span class="line">        sessionManager.setSessionFactory(sessionFactory());</span><br><span class="line">        //全局会话超时时间（单位毫秒），默认30分钟  暂时设置为10秒钟 用来测试</span><br><span class="line">        sessionManager.setGlobalSessionTimeout(1800000);</span><br><span class="line">        //是否开启删除无效的session对象  默认为true</span><br><span class="line">        sessionManager.setDeleteInvalidSessions(true);</span><br><span class="line">        //是否开启定时调度器进行检测过期session 默认为true</span><br><span class="line">        sessionManager.setSessionValidationSchedulerEnabled(true);</span><br><span class="line">        //设置session失效的扫描时间, 清理用户直接关闭浏览器造成的孤立会话 默认为 1个小时</span><br><span class="line">        //设置该属性 就不需要设置 ExecutorServiceSessionValidationScheduler 底层也是默认自动调用ExecutorServiceSessionValidationScheduler</span><br><span class="line">        //暂时设置为 5秒 用来测试</span><br><span class="line">        sessionManager.setSessionValidationInterval(3600000);</span><br><span class="line">        //取消url 后面的 JSESSIONID</span><br><span class="line">        sessionManager.setSessionIdUrlRewritingEnabled(false);</span><br><span class="line">        return sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line">//    /**</span><br><span class="line">//     * 并发登录控制</span><br><span class="line">//     * @return</span><br><span class="line">//     */</span><br><span class="line">//    @Bean</span><br><span class="line">//    public KickoutSessionControlFilter kickoutSessionControlFilter()&#123;</span><br><span class="line">//        KickoutSessionControlFilter kickoutSessionControlFilter = new KickoutSessionControlFilter();</span><br><span class="line">//        //用于根据会话ID，获取会话进行踢出操作的；</span><br><span class="line">//        kickoutSessionControlFilter.setSessionManager(sessionManager());</span><br><span class="line">//        //使用cacheManager获取相应的cache来缓存用户登录的会话；用于保存用户—会话之间的关系的；</span><br><span class="line">//        kickoutSessionControlFilter.setRedisManager(redisManager());</span><br><span class="line">//        //是否踢出后来登录的，默认是false；即后者登录的用户踢出前者登录的用户；</span><br><span class="line">//        kickoutSessionControlFilter.setKickoutAfter(false);</span><br><span class="line">//        //同一个用户最大的会话数，默认1；比如2的意思是同一个用户允许最多同时两个人登录；</span><br><span class="line">//        kickoutSessionControlFilter.setMaxSession(1);</span><br><span class="line">//        //被踢出后重定向到的地址；</span><br><span class="line">////        kickoutSessionControlFilter.setKickoutUrl(&quot;/login?kickout=1&quot;);</span><br><span class="line">//        return kickoutSessionControlFilter;</span><br><span class="line">//    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置密码比较器</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean(&quot;credentialsMatcher&quot;)</span><br><span class="line">    public RetryLimitHashedCredentialsMatcher retryLimitHashedCredentialsMatcher()&#123;</span><br><span class="line">        RetryLimitHashedCredentialsMatcher retryLimitHashedCredentialsMatcher = new RetryLimitHashedCredentialsMatcher();</span><br><span class="line">        retryLimitHashedCredentialsMatcher.setRedisManager(redisManager());</span><br><span class="line">        //如果密码加密,可以打开下面配置</span><br><span class="line">        //加密算法的名称</span><br><span class="line">        //retryLimitHashedCredentialsMatcher.setHashAlgorithmName(&quot;MD5&quot;);</span><br><span class="line">        //配置加密的次数</span><br><span class="line">        //retryLimitHashedCredentialsMatcher.setHashIterations(1024);</span><br><span class="line">        //是否存储为16进制</span><br><span class="line">        //retryLimitHashedCredentialsMatcher.setStoredCredentialsHexEncoded(true);</span><br><span class="line">        return retryLimitHashedCredentialsMatcher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShiroRealm"><a href="#ShiroRealm" class="headerlink" title="ShiroRealm"></a><strong>ShiroRealm</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">package com.panghu.shiro;</span><br><span class="line"></span><br><span class="line">import com.panghu.dao.SysUserDao;</span><br><span class="line">import com.panghu.entity.SysRole;</span><br><span class="line">import com.panghu.entity.SysUser;</span><br><span class="line">import com.panghu.global.MyByteSource;</span><br><span class="line">import org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line">import org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line">import org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line">import org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line">import org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line">import org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line">import org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line">import org.apache.shiro.util.ByteSource;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @ProjectName: nacos_base4j</span><br><span class="line"> * @Package: com.panghu</span><br><span class="line"> * @ClassName: MyShiroRealm</span><br><span class="line"> * @Author: wxy</span><br><span class="line"> * @Description: 拦截实现</span><br><span class="line"> * @Date: 2020/5/5 14:23</span><br><span class="line"> * @Version: 1.0</span><br><span class="line"> */</span><br><span class="line">public class ShiroRealm extends AuthorizingRealm &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private SysUserDao userDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 用户权限配置</span><br><span class="line">     * @Param: [principals]</span><br><span class="line">     * @return: org.apache.shiro.authz.AuthorizationInfo</span><br><span class="line">     * @Author: Mr.Wei</span><br><span class="line">     * @Date: 2020/5/19</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) &#123;</span><br><span class="line">        System.out.println(&quot;权限调用方法开始&quot;);</span><br><span class="line">        SimpleAuthorizationInfo authorizationInfo = new SimpleAuthorizationInfo();</span><br><span class="line">        SysUser userInfo = (SysUser) principals.getPrimaryPrincipal();</span><br><span class="line">        for (SysRole role : userInfo.getRoles()) &#123;</span><br><span class="line">            authorizationInfo.addRoles(new ArrayList&lt;&gt;());</span><br><span class="line"></span><br><span class="line">            authorizationInfo.addStringPermission(&quot;321&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return authorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 身份验证</span><br><span class="line">     * @Param: [token]</span><br><span class="line">     * @return: org.apache.shiro.authc.AuthenticationInfo</span><br><span class="line">     * @Author: Mr.Wei</span><br><span class="line">     * @Date: 2020/5/5</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) &#123;</span><br><span class="line">        System.out.println(&quot;MyShiroRealm.doGetAuthenticationInfo()&quot;);</span><br><span class="line"></span><br><span class="line">        // 获取用户的输入的账号.</span><br><span class="line">        String name = (String) token.getPrincipal();</span><br><span class="line">        System.out.println(token.getCredentials());</span><br><span class="line"></span><br><span class="line">        // 通过name和password从数据库中查找 User对象，</span><br><span class="line">        SysUser userInfo = userDao.findByAccount(name);</span><br><span class="line">        if (userInfo == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String uid = userInfo.getId();</span><br><span class="line">//        List&lt;Role&gt; roles = userService.getRoles(uid);</span><br><span class="line">//        int roleId = roles.get(0).getId();</span><br><span class="line">//        List&lt;Permission&gt; permissions = userService.getPermissions(roleId);</span><br><span class="line">//        roles.get(0).setPermissions(permissions);</span><br><span class="line">//        userInfo.setRoleList(roles);</span><br><span class="line">        // 加密方式;</span><br><span class="line">        // 交给AuthenticatingRealm使用CredentialsMatcher进行密码匹配</span><br><span class="line">        String password = userInfo.getPassword();</span><br><span class="line">        // 秘钥</span><br><span class="line">        ByteSource salt = ByteSource.Util.bytes(userInfo.getAccount());</span><br><span class="line">        // 当前域的名称（MyShiroRealm）</span><br><span class="line">        String realmName = getName();</span><br><span class="line">        // 认证信息</span><br><span class="line">//        SimpleAuthenticationInfo authenticationInfo = new SimpleAuthenticationInfo(userInfo.getAccount(), password, salt, realmName);</span><br><span class="line">        SimpleAuthenticationInfo info = new SimpleAuthenticationInfo(userInfo, userInfo.getPassword(), new MyByteSource(userInfo.getUserName()), getName());</span><br><span class="line"></span><br><span class="line">        return info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShiroSession"><a href="#ShiroSession" class="headerlink" title="ShiroSession"></a>ShiroSession</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">package com.panghu.shiro;</span><br><span class="line"></span><br><span class="line">import org.apache.shiro.session.InvalidSessionException;</span><br><span class="line">import org.apache.shiro.session.mgt.SimpleSession;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @ProjectName: nacos_base4j</span><br><span class="line"> * @Package: com.panghu.shiro</span><br><span class="line"> * @ClassName: ShiroSession</span><br><span class="line"> * @Author: wxy</span><br><span class="line"> * @Description: session 由于SimpleSession lastAccessTime更改后也会调用SessionDao update方法，</span><br><span class="line"> * 增加标识位，如果只是更新lastAccessTime SessionDao update方法直接返回</span><br><span class="line"> * @Date: 2020/5/19 10:39</span><br><span class="line"> * @Version: 1.0</span><br><span class="line"> */</span><br><span class="line">public class ShiroSession extends SimpleSession implements Serializable &#123;</span><br><span class="line">    // 除lastAccessTime以外其他字段发生改变时为true</span><br><span class="line">    private boolean isChanged = false;</span><br><span class="line"></span><br><span class="line">//    private String id = &quot;init&quot;;</span><br><span class="line"></span><br><span class="line">    public ShiroSession() &#123;</span><br><span class="line">        super();</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public ShiroSession(String host) &#123;</span><br><span class="line">        super(host);</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setId(Serializable id) &#123;</span><br><span class="line">        super.setId(id);</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setStopTimestamp(Date stopTimestamp) &#123;</span><br><span class="line">        super.setStopTimestamp(stopTimestamp);</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setExpired(boolean expired) &#123;</span><br><span class="line">        super.setExpired(expired);</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setTimeout(long timeout) &#123;</span><br><span class="line">        super.setTimeout(timeout);</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setHost(String host) &#123;</span><br><span class="line">        super.setHost(host);</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setAttributes(Map&lt;Object, Object&gt; attributes) &#123;</span><br><span class="line">        super.setAttributes(attributes);</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setAttribute(Object key, Object value) &#123;</span><br><span class="line">        super.setAttribute(key, value);</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object removeAttribute(Object key) &#123;</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">        return super.removeAttribute(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 停止</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void stop() &#123;</span><br><span class="line">        super.stop();</span><br><span class="line">        this.setChanged(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 设置过期</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void expire() &#123;</span><br><span class="line">        this.stop();</span><br><span class="line">        this.setExpired(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isChanged() &#123;</span><br><span class="line">        return isChanged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setChanged(boolean isChanged) &#123;</span><br><span class="line">        this.isChanged = isChanged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean equals(Object obj) &#123;</span><br><span class="line">        return super.equals(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean onEquals(SimpleSession ss) &#123;</span><br><span class="line">        return super.onEquals(ss);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int hashCode() &#123;</span><br><span class="line">        return super.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return super.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Serializable getId() &#123;</span><br><span class="line">        return super.getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Date getStartTimestamp() &#123;</span><br><span class="line">        return super.getStartTimestamp();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setStartTimestamp(Date startTimestamp) &#123;</span><br><span class="line">        super.setStartTimestamp(startTimestamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Date getStopTimestamp() &#123;</span><br><span class="line">        return super.getStopTimestamp();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Date getLastAccessTime() &#123;</span><br><span class="line">        return super.getLastAccessTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setLastAccessTime(Date lastAccessTime) &#123;</span><br><span class="line">        super.setLastAccessTime(lastAccessTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean isExpired() &#123;</span><br><span class="line">        return super.isExpired();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public long getTimeout() &#123;</span><br><span class="line">        return super.getTimeout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getHost() &#123;</span><br><span class="line">        return super.getHost();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Map&lt;Object, Object&gt; getAttributes() &#123;</span><br><span class="line">        return super.getAttributes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void touch() &#123;</span><br><span class="line">        super.touch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isStopped() &#123;</span><br><span class="line">        return super.isStopped();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean isValid() &#123;</span><br><span class="line">        return super.isValid();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isTimedOut() &#123;</span><br><span class="line">        return super.isTimedOut();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void validate() throws InvalidSessionException &#123;</span><br><span class="line">        super.validate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;Object&gt; getAttributeKeys() throws InvalidSessionException &#123;</span><br><span class="line">        return super.getAttributeKeys();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object getAttribute(Object key) &#123;</span><br><span class="line">        return super.getAttribute(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShiroSessionFactory"><a href="#ShiroSessionFactory" class="headerlink" title="ShiroSessionFactory"></a>ShiroSessionFactory</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">package com.panghu.shiro;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.lang3.StringUtils;</span><br><span class="line">import org.apache.shiro.session.Session;</span><br><span class="line">import org.apache.shiro.session.mgt.SessionContext;</span><br><span class="line">import org.apache.shiro.session.mgt.SessionFactory;</span><br><span class="line">import org.apache.shiro.web.session.mgt.DefaultWebSessionContext;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @ProjectName: nacos_base4j</span><br><span class="line"> * @Package: com.panghu.shiro</span><br><span class="line"> * @ClassName: ShiroSessionFactory</span><br><span class="line"> * @Author: wxy</span><br><span class="line"> * @Description: sessionFactory</span><br><span class="line"> * @Date: 2020/5/19 17:03</span><br><span class="line"> * @Version: 1.0</span><br><span class="line"> */</span><br><span class="line">public class ShiroSessionFactory implements SessionFactory &#123;</span><br><span class="line">    private static final Logger logger = LoggerFactory.getLogger(ShiroSessionFactory.class);</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Session createSession(SessionContext initData) &#123;</span><br><span class="line">        ShiroSession session = new ShiroSession();</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest)initData.get(DefaultWebSessionContext.class.getName() + &quot;.SERVLET_REQUEST&quot;);</span><br><span class="line">        session.setHost(getIpAddress(request));</span><br><span class="line">        return session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String getIpAddress(HttpServletRequest request) &#123;</span><br><span class="line">        String localIP = &quot;127.0.0.1&quot;;</span><br><span class="line">        String ip = request.getHeader(&quot;x-forwarded-for&quot;);</span><br><span class="line">        if (StringUtils.isBlank(ip) || (ip.equalsIgnoreCase(localIP)) || &quot;unknown&quot;.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(&quot;Proxy-Client-IP&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isBlank(ip) || (ip.equalsIgnoreCase(localIP)) || &quot;unknown&quot;.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(&quot;WL-Proxy-Client-IP&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isBlank(ip) || (ip.equalsIgnoreCase(localIP)) || &quot;unknown&quot;.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getRemoteAddr();</span><br><span class="line">        &#125;</span><br><span class="line">        return ip;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShiroSessionListener"><a href="#ShiroSessionListener" class="headerlink" title="ShiroSessionListener"></a>ShiroSessionListener</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @ProjectName: nacos_base4j</span><br><span class="line"> * @Package: com.panghu.shiro</span><br><span class="line"> * @ClassName: ShiroSessionListener</span><br><span class="line"> * @Author: wxy</span><br><span class="line"> * @Description: 在线人数监听</span><br><span class="line"> * @Date: 2020/5/19 16:57</span><br><span class="line"> * @Version: 1.0</span><br><span class="line"> */</span><br><span class="line">public class ShiroSessionListener implements SessionListener &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 统计在线人数</span><br><span class="line">     * juc包下线程安全自增</span><br><span class="line">     */</span><br><span class="line">    private final AtomicInteger sessionCount = new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 会话创建时触发</span><br><span class="line">     *</span><br><span class="line">     * @param session</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onStart(Session session) &#123;</span><br><span class="line">        //会话创建，在线人数加一</span><br><span class="line">        sessionCount.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 退出会话时触发</span><br><span class="line">     *</span><br><span class="line">     * @param session</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onStop(Session session) &#123;</span><br><span class="line">        //会话退出,在线人数减一</span><br><span class="line">        sessionCount.decrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 会话过期时触发</span><br><span class="line">     *</span><br><span class="line">     * @param session</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onExpiration(Session session) &#123;</span><br><span class="line">        //会话过期,在线人数减一</span><br><span class="line">        sessionCount.decrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取在线人数使用</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public AtomicInteger getSessionCount() &#123;</span><br><span class="line">        return sessionCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ShiroSessionManager"><a href="#ShiroSessionManager" class="headerlink" title="ShiroSessionManager"></a>ShiroSessionManager</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com.panghu.shiro;</span><br><span class="line"></span><br><span class="line">import com.panghu.reids.RedisSessionDAO;</span><br><span class="line">import org.apache.shiro.session.Session;</span><br><span class="line">import org.apache.shiro.session.UnknownSessionException;</span><br><span class="line">import org.apache.shiro.session.mgt.SessionKey;</span><br><span class="line">import org.apache.shiro.session.mgt.eis.SessionDAO;</span><br><span class="line">import org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line">import org.apache.shiro.web.session.mgt.WebSessionKey;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line">import javax.servlet.ServletRequest;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @ProjectName: nacos_base4j</span><br><span class="line"> * @Package: com.panghu.shiro</span><br><span class="line"> * @ClassName: ShiroSessionManager</span><br><span class="line"> * @Author: wxy</span><br><span class="line"> * @Description: session管理</span><br><span class="line"> * @Date: 2020/5/19 17:01</span><br><span class="line"> * @Version: 1.0</span><br><span class="line"> */</span><br><span class="line">public class ShiroSessionManager extends DefaultWebSessionManager &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(DefaultWebSessionManager.class);</span><br><span class="line">    /**</span><br><span class="line">     * 获取session</span><br><span class="line">     * 优化单次请求需要多次访问redis的问题</span><br><span class="line">     * @param sessionKey</span><br><span class="line">     * @return</span><br><span class="line">             * @throws UnknownSessionException</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected Session retrieveSession(SessionKey sessionKey) throws UnknownSessionException &#123;</span><br><span class="line">        Serializable sessionId = getSessionId(sessionKey);</span><br><span class="line"></span><br><span class="line">        ServletRequest request = null;</span><br><span class="line">        if (sessionKey instanceof WebSessionKey) &#123;</span><br><span class="line">            request = ((WebSessionKey) sessionKey).getServletRequest();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (request != null &amp;&amp; null != sessionId) &#123;</span><br><span class="line">            Object sessionObj = request.getAttribute(sessionId.toString());</span><br><span class="line">            if (sessionObj != null) &#123;</span><br><span class="line">                logger.debug(&quot;read session from request&quot;);</span><br><span class="line">                return (Session) sessionObj;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Session session = super.retrieveSession(sessionKey);</span><br><span class="line">        if (request != null &amp;&amp; null != sessionId) &#123;</span><br><span class="line">            request.setAttribute(sessionId.toString(), session);</span><br><span class="line">        &#125;</span><br><span class="line">        return session;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/spring-cloud-alibaba/" rel="tag"><i class="fa fa-tag"></i> spring cloud alibaba</a>
          
            <a href="/tags/shiro/" rel="tag"><i class="fa fa-tag"></i> shiro</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/15/二叉树/" rel="next" title>
                <i class="fa fa-chevron-left"></i> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/13/spring-cloud-zuul集成管理swagger/" rel="prev" title="spring-cloud zuul集成管理swagger">
                spring-cloud zuul集成管理swagger <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  <div>
    
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">------ 本文结束------</div>
    
</div>
    
 </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>
  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">
      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

		  <div id="music163player">
			<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=28285910&auto=1&height=66">
			</iframe>
		  </div>
      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/sliver.jpg" alt="wei xy">
            
              <p class="site-author-name" itemprop="name">wei xy</p>
              <p class="site-description motion-element" itemprop="description">一步一步似爪牙</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">59</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/yourname" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/yourname" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/yourname" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://vk.com/yourname" target="_blank" title="VK Group">
                      
                        <i class="fa fa-fw fa-vk"></i>VK Group</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/yourname" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://youtube.com/yourname" target="_blank" title="YouTube">
                      
                        <i class="fa fa-fw fa-youtube"></i>YouTube</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/yourname" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="skype:yourname?call|chat" target="_blank" title="Skype">
                      
                        <i class="fa fa-fw fa-skype"></i>Skype</a>
                  </span>
                
            </div>
          

          
          

          
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-cloud-集成shiro"><span class="nav-number">1.</span> <span class="nav-text">Spring cloud 集成shiro</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义序列化类SerializeUtils"><span class="nav-number">1.0.1.</span> <span class="nav-text">自定义序列化类SerializeUtils</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RedisConfig"><span class="nav-number">1.0.2.</span> <span class="nav-text">RedisConfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RedisManager"><span class="nav-number">1.0.3.</span> <span class="nav-text">RedisManager</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-作为缓存管理shiro"><span class="nav-number">1.1.</span> <span class="nav-text">redis 作为缓存管理shiro</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RedisCache"><span class="nav-number">1.1.1.</span> <span class="nav-text">RedisCache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RedisCacheManager"><span class="nav-number">1.1.2.</span> <span class="nav-text">RedisCacheManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RedisSessionDAO"><span class="nav-number">1.1.3.</span> <span class="nav-text">RedisSessionDAO</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shiro配置"><span class="nav-number">1.2.</span> <span class="nav-text">shiro配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ShiroConfig"><span class="nav-number">1.2.1.</span> <span class="nav-text">ShiroConfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShiroRealm"><span class="nav-number">1.2.2.</span> <span class="nav-text">ShiroRealm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShiroSession"><span class="nav-number">1.2.3.</span> <span class="nav-text">ShiroSession</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShiroSessionFactory"><span class="nav-number">1.2.4.</span> <span class="nav-text">ShiroSessionFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShiroSessionListener"><span class="nav-number">1.2.5.</span> <span class="nav-text">ShiroSessionListener</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ShiroSessionManager"><span class="nav-number">1.2.6.</span> <span class="nav-text">ShiroSessionManager</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>



        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wei xy</span>

  
</div>
	<!--div class="powered-by">
		<i class="fa fa-user-md"></i>
		<span id="busuanzi_container_site_uv">
			本站访客数:<span id="busuanzi_value_site_uv"></span>
		</span>
	</div -->

<!-- 
  <div class="powered-by">由  强力驱动</div>


  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash;  v5.1.4</div>

-->



        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

	<!-- 代码块复制功能 -->
	<script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
	<script type="text/javascript" src="/js/src/clipboard-use.js"></script>
	<!--动态标题-->
	<script type="text/javascript" src="/js/src/dytitle.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"symbols":true,"time":true,"total_symbols":true,"total_time":true,"log":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
